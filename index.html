<script>
(function () {
  const E164 = "380979351325";               // digits only, include country code
  const VIBER_CHAT    = "viber://chat?number=" + E164;
  const VIBER_CONTACT = "viber://contact?number=%2B" + E164; // note %2B (encoded +)
  const PLAY = "https://play.google.com/store/apps/details?id=com.viber.voip";
  const IOS  = "https://apps.apple.com/app/id382617920";

  const ua = navigator.userAgent;
  const isAndroid = /Android/i.test(ua);
  const isiOS = /iPhone|iPad|iPod/i.test(ua) || (/Macintosh/.test(ua) && navigator.maxTouchPoints > 2);

  // Mark as "launched" when the page loses focus/visibility (likely because Viber opened)
  let launched = false;
  const mark = () => { launched = true; };
  window.addEventListener('pagehide', mark, {once:true});
  window.addEventListener('blur', mark, {once:true});
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') mark();
  }, {once:true});

  function closeOrBlank() {
    try { window.close(); } catch {}
    try { window.open('', '_self'); window.close(); } catch {}
    setTimeout(() => { if (launched) location.replace('about:blank'); }, 200);
  }

  if (isAndroid) {
    // Chrome Intent: only uses fallback if Viber isn't installed
    const intent = "intent://chat?number=" + E164 +
      "#Intent;scheme=viber;package=com.viber.voip;" +
      "S.browser_fallback_url=" + encodeURIComponent(PLAY) + ";end";
    location.href = intent;  // No timer needed on Android
  } else {
    // iOS & others: try chat, then contact (some builds prefer contact+%2B)
    location.href = VIBER_CHAT;
    setTimeout(() => { location.href = VIBER_CONTACT; }, 350);

    // Fallback ONLY if app didn't open
    setTimeout(() => {
      if (launched) { closeOrBlank(); return; }
      if (isiOS) location.href = IOS;
    }, 1500);
  }
})();
</script>
